<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ’ ASHI SmartPix</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.png') }}">
</head>

<body style="text-align:center;font-family:Poppins;background:#fff0f5;margin:0;">

  <h1 style="margin-top:25px;color:#b83b5e;font-size:2rem;">ğŸ’ ASHI SmartPix</h1>
  <p>Take a selfie to find your special memories instantly ğŸ’</p>

  <video id="camera" autoplay playsinline style="width:80%;max-width:420px;border-radius:18px;border:3px solid #ff6b81;"></video>
  <canvas id="canvas" style="display:none;"></canvas><br>

  <button id="captureBtn" style="background:#ff6b81;color:white;padding:14px 28px;border:none;font-size:18px;border-radius:30px;margin-top:20px;">ğŸ¯ Capture & Find Photos</button>

  <div id="spinner" style="display:none;margin-top:40px;font-size:18px;color:#e63946;">Please wait... Scanning photos ğŸ¤–</div>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const spinner = document.getElementById("spinner");
const captureBtn = document.getElementById("captureBtn");

// Start camera
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
  }catch(e){
    alert("Allow camera access to continue");
  }
}
startCamera();

// Stop camera
function stopCamera(){
  const stream = video.srcObject;
  if(stream) stream.getTracks().forEach(t=>t.stop());
  video.srcObject=null;
}

// CAPTURE SELFIE
captureBtn.onclick = ()=>{
  spinner.style.display="block";
  captureBtn.style.display="none";

  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  stopCamera();

  canvas.toBlob((blob)=>{
    const fd = new FormData();
    fd.append("file", blob, "selfie.jpg");

    const event = "{{ event }}";  // Flask injects the actual event name (e.g. event_A)
    console.log("ğŸ“¸ Uploading selfie for event:", event);

    fetch(`/upload/${event}`, { method: "POST", body: fd })
      .then(res => {
        window.location.href = "/result"; // Redirect to result page after matching
      })
      .catch(err => {
        console.error("âŒ Upload error:", err);
        alert("Server error, please try again.");
      });

  }, "image/jpeg");
}
</script>
</body>
</html>
